<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DJ Queue - QR Code</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-600 to-blue-600 min-h-screen flex items-center justify-center p-4">

  <div class="max-w-2xl w-full">
    <!-- Carte QR Code -->
    <div class="bg-white rounded-2xl shadow-2xl p-8 text-center">
      <h1 id="eventName" class="text-3xl font-bold text-gray-800 mb-2">Soir√©e</h1>
      <p class="text-gray-600 mb-8">Scanne le QR code pour rejoindre !</p>

      <!-- QR Code -->
      <div class="flex justify-center mb-8">
        <img id="qrCode" src="" alt="QR Code" class="w-80 h-80 border-4 border-purple-200 rounded-xl">
      </div>

      <!-- URL -->
      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <p class="text-sm text-gray-600 mb-2">Ou partage ce lien :</p>
        <div class="flex items-center gap-2">
          <input 
            id="eventUrl" 
            type="text" 
            readonly 
            class="flex-1 px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm"
          >
          <button 
            onclick="copyUrl()"
            class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-lg transition"
          >
            üìã Copier
          </button>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-3 justify-center">
        <button 
          onclick="printQR()"
          class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition"
        >
          üñ®Ô∏è Imprimer
        </button>
        <button 
          onclick="goToDJ()"
          class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition"
        >
          üéß Interface DJ
        </button>
        <button 
          onclick="backToDashboard()"
          class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition"
        >
          ‚Üê Dashboard
        </button>
      </div>
    </div>

    <!-- Stats en temps r√©el -->
    <div class="mt-6 bg-white rounded-xl shadow p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">üìä Stats en temps r√©el</h2>
      <div class="grid grid-cols-3 gap-4 text-center">
        <div>
          <p class="text-3xl font-bold text-purple-600" id="pendingCount">0</p>
          <p class="text-sm text-gray-600">En attente</p>
        </div>
        <div>
          <p class="text-3xl font-bold text-green-600" id="queueCount">0</p>
          <p class="text-sm text-gray-600">Dans la queue</p>
        </div>
        <div>
          <p class="text-3xl font-bold text-blue-600" id="playedCount">0</p>
          <p class="text-sm text-gray-600">Jou√©es</p>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const eventId = window.location.pathname.split('/')[2];
    const socket = io();

    // Charger les donn√©es
    fetch(`/api/events/${eventId}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('eventName').textContent = data.name;
        document.getElementById('eventUrl').value = window.location.origin + '/user/' + eventId;

        // G√©n√©rer QR code
        fetch(`/api/events/${eventId}/qrcode`)
          .then(r => r.json())
          .then(qr => {
            document.getElementById('qrCode').src = qr.qrCode;
          });

        updateStats();
      });

    // WebSocket pour stats temps r√©el
    socket.emit('join-event', eventId);

    socket.on('new-request', () => updateStats());
    socket.on('request-accepted', () => updateStats());
    socket.on('queue-updated', () => updateStats());

    async function updateStats() {
      const response = await fetch(`/api/events/${eventId}/stats`);
      const data = await response.json();

      document.getElementById('pendingCount').textContent = data.stats.pending_count || 0;
      document.getElementById('queueCount').textContent = data.stats.accepted_count || 0;
      document.getElementById('playedCount').textContent = data.stats.played_count || 0;
    }

    function copyUrl() {
      const url = document.getElementById('eventUrl');
      url.select();
      document.execCommand('copy');
      alert('‚úÖ Lien copi√© !');
    }

    function printQR() {
      window.print();
    }

    function goToDJ() {
      window.location.href = `/dj/${eventId}`;
    }

    function backToDashboard() {
      window.location.href = '/dashboard';
    }
  </script>

  <style>
    @media print {
      body { background: white; }
      button { display: none; }
      .mt-6 { display: none; }
    }
  </style>
</body>
</html>