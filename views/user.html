<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DJ Queue - Proposer une chanson</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
    if (localStorage.getItem('darkMode') === 'true') {
      document.documentElement.classList.add('dark');
    }
  </script>
</head>
<body class="bg-gradient-to-br from-pink-500 to-purple-600 dark:from-gray-900 dark:to-gray-800 min-h-screen p-4 transition-colors duration-300">

  <!-- Toggle mode sombre -->
  <button 
    id="darkModeToggle"
    onclick="toggleDarkMode()"
    class="fixed top-4 right-4 bg-white dark:bg-gray-800 text-gray-800 dark:text-white p-3 rounded-full shadow-lg hover:scale-110 transition-transform z-50"
  >
    <span id="darkModeIcon">üåô</span>
  </button>

  <div class="max-w-2xl mx-auto">
    <!-- Rate limit banner -->
    <div id="rateLimitBanner" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 mb-4 hidden transition-colors duration-300">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Demandes restantes</p>
          <p class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="remainingRequests">3</p>
        </div>
        <div class="text-4xl">‚è±Ô∏è</div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-6 mb-4 transition-colors duration-300">
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-white mb-1">üéµ Propose une chanson</h1>
      <p class="text-sm text-gray-600 dark:text-gray-300 mb-6" id="eventName">Chargement...</p>

      <!-- Barre de recherche Spotify -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          üîç Rechercher sur Spotify
        </label>
        <input 
          type="text" 
          id="searchInput" 
          placeholder="Titre, artiste..."
          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition"
        >
      </div>

      <!-- R√©sultats de recherche -->
      <div id="searchResults" class="space-y-2 mb-4 max-h-96 overflow-y-auto"></div>

      <!-- Message d'erreur -->
      <div id="errorMessage" class="hidden bg-red-50 dark:bg-red-900/30 border-2 border-red-200 dark:border-red-800 rounded-lg p-4 mb-4 transition-colors duration-300">
        <div class="flex items-start gap-3">
          <span class="text-2xl">‚ö†Ô∏è</span>
          <div>
            <p class="font-bold text-red-800 dark:text-red-300 mb-1">Oups !</p>
            <p class="text-sm text-red-700 dark:text-red-400" id="errorText"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Mes demandes -->
    <div id="myRequests" class="space-y-3 mb-4"></div>

    <!-- Queue compl√®te (avec votes) -->
    <div id="queueSection" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-6 transition-colors duration-300">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-white mb-4">
        üéµ Prochaines chansons
        <span id="queueCount" class="text-sm font-normal text-gray-500 dark:text-gray-400">(0)</span>
      </h2>
      <p id="votesDisabledMsg" class="hidden text-sm text-gray-600 dark:text-gray-400 mb-4">
        Les votes sont d√©sactiv√©s par le DJ
      </p>
      <div id="fullQueue" class="space-y-3">
        <p class="text-gray-500 dark:text-gray-400 text-center py-8">Aucune chanson en attente</p>
      </div>
    </div>
  </div>

  <script>
    const eventId = window.location.pathname.split('/')[2];
    const socket = io();
    const myRequests = new Map();
    const myVotes = new Map();
    let fullQueue = [];
    let searchTimeout;
    let currentRateLimit = { count: 0, max: 3, remaining: 3 };
    let votesEnabled = true;

    socket.emit('join-event', eventId);

    // Charger l'√©v√©nement
    fetch(`/api/events/${eventId}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('eventName').textContent = data.name;
        votesEnabled = data.votes_enabled;
        fullQueue = data.queue || [];
        updateQueueDisplay();

        if (!votesEnabled) {
          document.getElementById('votesDisabledMsg').classList.remove('hidden');
        }
      });

    // Mode sombre
    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark);
      updateDarkModeIcon();
    }

    function updateDarkModeIcon() {
      const isDark = document.documentElement.classList.contains('dark');
      document.getElementById('darkModeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    updateDarkModeIcon();

    // Rate limit
    socket.on('rate-limit-status', (status) => {
      currentRateLimit = status;
      updateRateLimitDisplay();
    });

    function updateRateLimitDisplay() {
      const banner = document.getElementById('rateLimitBanner');
      const remaining = document.getElementById('remainingRequests');

      if (currentRateLimit.remaining !== undefined) {
        remaining.textContent = currentRateLimit.remaining;
        banner.classList.remove('hidden');

        if (currentRateLimit.remaining === 0) {
          banner.classList.add('bg-red-50', 'dark:bg-red-900/30', 'border-2', 'border-red-200', 'dark:border-red-800');
        }
      }
    }

    // Recherche Spotify
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.trim();
      clearTimeout(searchTimeout);

      if (query.length < 2) {
        document.getElementById('searchResults').innerHTML = '';
        return;
      }

      searchTimeout = setTimeout(() => {
        searchSpotify(query);
      }, 500);
    });

    async function searchSpotify(query) {
      try {
        const response = await fetch(`/api/spotify/search?q=${encodeURIComponent(query)}&eventId=${eventId}`);
        const data = await response.json();
        displaySearchResults(data.tracks);
      } catch (error) {
        console.error('Erreur recherche:', error);
      }
    }

    function displaySearchResults(tracks) {
      const container = document.getElementById('searchResults');

      if (!tracks || tracks.length === 0) {
        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm text-center py-4">Aucun r√©sultat</p>';
        return;
      }

      container.innerHTML = tracks.map(track => `
        <div 
          class="flex items-center gap-3 p-3 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition"
          onclick='selectTrack(${JSON.stringify(track)})'
        >
          <img src="${track.image}" alt="${track.name}" class="w-12 h-12 rounded">
          <div class="flex-1 min-w-0">
            <h4 class="font-semibold text-gray-800 dark:text-white truncate">${track.name}</h4>
            <p class="text-sm text-gray-600 dark:text-gray-300 truncate">${track.artist}</p>
          </div>
          <button class="text-purple-600 dark:text-purple-400 font-bold text-xl">+</button>
        </div>
      `).join('');
    }

    function selectTrack(track) {
      hideError();

      const userName = prompt('Ton pr√©nom (optionnel) :') || 'Anonyme';

      socket.emit('request-song', {
        eventId,
        songData: track,
        userName
      });

      document.getElementById('searchInput').value = '';
      document.getElementById('searchResults').innerHTML = '';
    }

    function showError(message) {
      document.getElementById('errorText').innerHTML = message.replace(/\n/g, '<br>');
      document.getElementById('errorMessage').classList.remove('hidden');

      setTimeout(() => {
        hideError();
      }, 8000);
    }

    function hideError() {
      document.getElementById('errorMessage').classList.add('hidden');
    }

    // Voter pour une chanson
    function vote(requestId, voteType) {
      if (!votesEnabled) {
        showError('Les votes sont d√©sactiv√©s par le DJ');
        return;
      }
      socket.emit('vote', { requestId, voteType });
      myVotes.set(requestId, voteType);
    }

    // Gestion des √©v√©nements socket
    socket.on('request-error', (error) => {
      if (error.type === 'rate-limit') {
        showError(`‚è±Ô∏è ${error.message}`);
      } else if (error.type === 'duplicate') {
        showError(`üéµ ${error.message}`);
      } else {
        showError(error.message);
      }
    });

    socket.on('request-created', (data) => {
      myRequests.set(data.requestId, {
        status: 'pending',
        ...data
      });

      if (data.rateLimitStatus) {
        currentRateLimit = data.rateLimitStatus;
        updateRateLimitDisplay();
      }

      updateMyRequests();
    });

    socket.on('your-request-accepted', (data) => {
      const request = myRequests.get(data.requestId);
      if (request) {
        request.status = 'accepted';
        request.position = data.position;
        updateMyRequests();
      }
    });

    socket.on('your-request-rejected', (data) => {
      const request = myRequests.get(data.requestId);
      if (request) {
        request.status = 'rejected';
        updateMyRequests();
      }
    });

    socket.on('queue-updated', (data) => {
      fullQueue = data.queue;

      myRequests.forEach((request, id) => {
        if (request.status === 'accepted') {
          const position = data.queue.findIndex(r => r.id === id) + 1;
          if (position > 0) {
            request.position = position;
          } else {
            request.status = 'played';
          }
        }
      });

      updateMyRequests();
      updateQueueDisplay();
    });

    socket.on('vote-updated', (data) => {
      const request = myRequests.get(data.requestId);
      if (request) {
        request.upvotes = data.upvotes;
        request.downvotes = data.downvotes;
        updateMyRequests();
      }

      // Mettre √† jour la queue compl√®te
      const queueItem = fullQueue.find(r => r.id === data.requestId);
      if (queueItem) {
        queueItem.upvotes = data.upvotes;
        queueItem.downvotes = data.downvotes;
        updateQueueDisplay();
      }
    });

    socket.on('event-settings-updated', (data) => {
      votesEnabled = data.votesEnabled;
      if (!votesEnabled) {
        document.getElementById('votesDisabledMsg').classList.remove('hidden');
      } else {
        document.getElementById('votesDisabledMsg').classList.add('hidden');
      }
      updateQueueDisplay();
    });

    function updateMyRequests() {
      const container = document.getElementById('myRequests');
      container.innerHTML = '';

      myRequests.forEach((request, id) => {
        const div = document.createElement('div');
        div.className = 'bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 transition-colors duration-300';

        let statusHtml = '';
        let statusClass = '';

        if (request.status === 'pending') {
          statusClass = 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300';
          statusHtml = '‚è≥ En attente';
        } else if (request.status === 'accepted') {
          statusClass = 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300';
          const estimatedTime = request.position * 3;
          statusHtml = `‚úÖ Accept√©e - Position ${request.position} (~${estimatedTime} min)`;
        } else if (request.status === 'rejected') {
          statusClass = 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300';
          statusHtml = '‚ùå Refus√©e';
        } else if (request.status === 'played') {
          statusClass = 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300';
          statusHtml = '‚úì Jou√©e';
        }

        const upvotes = request.upvotes || 0;
        const downvotes = request.downvotes || 0;
        const myVote = myVotes.get(id);

        div.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
              <h3 class="font-bold text-gray-800 dark:text-white">${request.songName || 'Ta chanson'}</h3>
              <p class="text-sm text-gray-600 dark:text-gray-300">${request.artist || ''}</p>
            </div>
          </div>

          ${request.status === 'accepted' && votesEnabled ? `
          <div class="flex gap-2 mb-2">
            <button 
              onclick="vote('${id}', 'up')"
              class="flex items-center gap-1 px-3 py-1 rounded-lg transition ${myVote === 'up' ? 'bg-green-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-green-100 dark:hover:bg-green-900/30'}"
            >
              üëç <span class="font-bold">${upvotes}</span>
            </button>
            <button 
              onclick="vote('${id}', 'down')"
              class="flex items-center gap-1 px-3 py-1 rounded-lg transition ${myVote === 'down' ? 'bg-red-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-red-100 dark:hover:bg-red-900/30'}"
            >
              üëé <span class="font-bold">${downvotes}</span>
            </button>
          </div>
          ` : ''}

          <div class="mt-2">
            <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">
              ${statusHtml}
            </span>
          </div>
        `;

        container.appendChild(div);
      });
    }

    function updateQueueDisplay() {
      const container = document.getElementById('fullQueue');
      document.getElementById('queueCount').textContent = `(${fullQueue.length})`;

      if (fullQueue.length === 0) {
        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Aucune chanson en attente</p>';
        return;
      }

      container.innerHTML = fullQueue.map((song, index) => {
        const netVotes = (song.upvotes || 0) - (song.downvotes || 0);
        const voteColor = netVotes > 0 ? 'text-green-600 dark:text-green-400' : netVotes < 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-600 dark:text-gray-400';
        const myVote = myVotes.get(song.id);

        return `
          <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 transition">
            <div class="flex items-start gap-3 mb-3">
              <div class="flex-shrink-0 w-8 h-8 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold text-sm">
                ${index + 1}
              </div>
              ${song.image_url ? `<img src="${song.image_url}" class="w-12 h-12 rounded hidden sm:block">` : ''}
              <div class="flex-1 min-w-0">
                <h3 class="font-bold text-gray-800 dark:text-white truncate">${song.song_name}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-300 truncate">${song.artist}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Par ${song.user_name}</p>
              </div>
            </div>

            ${votesEnabled ? `
            <div class="flex gap-2 items-center">
              <button 
                onclick="vote('${song.id}', 'up')"
                class="flex items-center gap-1 px-3 py-2 rounded-lg transition ${myVote === 'up' ? 'bg-green-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-green-100 dark:hover:bg-green-900/30'}"
              >
                üëç <span class="font-bold">${song.upvotes || 0}</span>
              </button>
              <button 
                onclick="vote('${song.id}', 'down')"
                class="flex items-center gap-1 px-3 py-2 rounded-lg transition ${myVote === 'down' ? 'bg-red-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-red-100 dark:hover:bg-red-900/30'}"
              >
                üëé <span class="font-bold">${song.downvotes || 0}</span>
              </button>
              <span class="text-sm ${voteColor} font-bold ml-2">
                Net: ${netVotes > 0 ? '+' : ''}${netVotes}
              </span>
            </div>
            ` : '<p class="text-sm text-gray-500 dark:text-gray-400">üëç ' + (song.upvotes || 0) + ' | üëé ' + (song.downvotes || 0) + '</p>'}
          </div>
        `;
      }).join('');
    }
  </script>
</body>
</html>