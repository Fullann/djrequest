<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DJ Queue - Proposer une chanson</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gradient-to-br from-pink-500 to-purple-600 min-h-screen p-4">
  <div class="max-w-md mx-auto">
    <div class="bg-white rounded-2xl shadow-2xl p-6 mb-4">
      <h1 class="text-3xl font-bold text-gray-800 mb-1">üéµ Propose une chanson</h1>
      <p class="text-gray-600 text-sm mb-6" id="eventName">Chargement...</p>

      <!-- Barre de recherche Spotify -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          üîç Rechercher sur Spotify
        </label>
        <input 
          type="text" 
          id="searchInput" 
          placeholder="Titre, artiste..."
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
        >
      </div>

      <!-- R√©sultats de recherche -->
      <div id="searchResults" class="space-y-2 mb-4 max-h-96 overflow-y-auto"></div>

      <!-- Formulaire manuel (fallback) -->
      <div id="manualForm" class="hidden">
        <p class="text-sm text-gray-600 mb-3">Ou ajoute manuellement :</p>
        <form id="requestForm" class="space-y-3">
          <input 
            type="text" 
            id="songName" 
            placeholder="Titre"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
            required
          >
          <input 
            type="text" 
            id="artist" 
            placeholder="Artiste"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
            required
          >
          <input 
            type="text" 
            id="userName" 
            placeholder="Ton pr√©nom (optionnel)"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
          >
          <button 
            type="submit"
            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg transition"
          >
            Proposer
          </button>
        </form>
      </div>

      <button 
        onclick="toggleManualForm()"
        class="text-sm text-purple-600 hover:text-purple-700 mt-2"
      >
        Ajouter manuellement
      </button>
    </div>

    <!-- Mes demandes -->
    <div id="myRequests" class="space-y-3"></div>
  </div>

  <script>
    const eventId = window.location.pathname.split('/')[2];
    const socket = io();
    const myRequests = new Map();
    let searchTimeout;

    socket.emit('join-event', eventId);

    fetch(`/api/events/${eventId}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('eventName').textContent = data.name;
      });

    // Recherche Spotify
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.trim();

      clearTimeout(searchTimeout);

      if (query.length < 2) {
        document.getElementById('searchResults').innerHTML = '';
        return;
      }

      searchTimeout = setTimeout(() => {
        searchSpotify(query);
      }, 500);
    });

    async function searchSpotify(query) {
      try {
        const response = await fetch(`/api/spotify/search?q=${encodeURIComponent(query)}&eventId=${eventId}`);
        const data = await response.json();

        displaySearchResults(data.tracks);
      } catch (error) {
        console.error('Erreur recherche:', error);
      }
    }

    function displaySearchResults(tracks) {
      const container = document.getElementById('searchResults');

      if (!tracks || tracks.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Aucun r√©sultat</p>';
        return;
      }

      container.innerHTML = tracks.map(track => `
        <div 
          class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition"
          onclick='selectTrack(${JSON.stringify(track)})'
        >
          <img src="${track.image}" alt="${track.name}" class="w-12 h-12 rounded">
          <div class="flex-1 min-w-0">
            <h4 class="font-semibold text-gray-800 truncate">${track.name}</h4>
            <p class="text-sm text-gray-600 truncate">${track.artist}</p>
          </div>
          <button class="text-purple-600 font-bold text-xl">+</button>
        </div>
      `).join('');
    }

    function selectTrack(track) {
      const userName = prompt('Ton pr√©nom (optionnel) :') || 'Anonyme';

      socket.emit('request-song', {
        eventId,
        songData: track,
        userName
      });

      document.getElementById('searchInput').value = '';
      document.getElementById('searchResults').innerHTML = '';
    }

    function toggleManualForm() {
      const form = document.getElementById('manualForm');
      form.classList.toggle('hidden');
    }

    // Formulaire manuel
    document.getElementById('requestForm').addEventListener('submit', (e) => {
      e.preventDefault();

      const songData = {
        name: document.getElementById('songName').value,
        artist: document.getElementById('artist').value,
        album: '',
        image: '',
        uri: '',
        duration_ms: 180000
      };

      const userName = document.getElementById('userName').value;

      socket.emit('request-song', {
        eventId,
        songData,
        userName
      });

      document.getElementById('requestForm').reset();
      toggleManualForm();
    });

    socket.on('request-created', (data) => {
      myRequests.set(data.requestId, {
        status: 'pending',
        ...data
      });
      updateMyRequests();
    });

    socket.on('your-request-accepted', (data) => {
      const request = myRequests.get(data.requestId);
      if (request) {
        request.status = 'accepted';
        request.position = data.position;
        updateMyRequests();
      }
    });

    socket.on('your-request-rejected', (data) => {
      const request = myRequests.get(data.requestId);
      if (request) {
        request.status = 'rejected';
        updateMyRequests();
      }
    });

    socket.on('queue-updated', (data) => {
      myRequests.forEach((request, id) => {
        if (request.status === 'accepted') {
          const position = data.queue.findIndex(r => r.id === id) + 1;
          if (position > 0) {
            request.position = position;
          }
        }
      });
      updateMyRequests();
    });

    function updateMyRequests() {
      const container = document.getElementById('myRequests');
      container.innerHTML = '';

      myRequests.forEach((request, id) => {
        const div = document.createElement('div');
        div.className = 'bg-white rounded-xl shadow-lg p-4';

        let statusHtml = '';
        let statusClass = '';

        if (request.status === 'pending') {
          statusClass = 'bg-yellow-100 text-yellow-800';
          statusHtml = '‚è≥ En attente';
        } else if (request.status === 'accepted') {
          statusClass = 'bg-green-100 text-green-800';
          const estimatedTime = request.position * 3;
          statusHtml = `‚úÖ Accept√©e - Position ${request.position} (~${estimatedTime} min)`;
        } else if (request.status === 'rejected') {
          statusClass = 'bg-red-100 text-red-800';
          statusHtml = '‚ùå Refus√©e';
        }

        div.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
              <h3 class="font-bold text-gray-800">${request.songName || 'Ta chanson'}</h3>
              <p class="text-sm text-gray-600">${request.artist || ''}</p>
            </div>
          </div>
          <div class="mt-2">
            <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">
              ${statusHtml}
            </span>
          </div>
        `;

        container.appendChild(div);
      });
    }
  </script>
</body>
</html>